<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthesizer</title>
    <style>
        :root {
            --bg-color: black;
            --code-bg-color: #1a1a1a;
            --text-color: white;
            --border-color: white;
            --op-bg-color: white;
            --op-text-color: black;
            --loop-color: #4CAF50; 
        }

        body.light-theme {
            --bg-color: white;
            --code-bg-color: #f0f0f0;
            --text-color: black;
            --border-color: black;
            --op-bg-color: black;
            --op-text-color: white;
            --loop-color: #2E7D32; 
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        body.retro-light-theme {
            --bg-color: white;
            --code-bg-color: #e0e0e0;
            --text-color: #000000;
            --border-color: #000000;
            --op-bg-color: #e6e6e6;
            --op-text-color: #000000;
            --loop-color: #2da195;
            font-family: 'MS Sans Serif', 'Arial', 'Monospace', sans-serif !important;
        }

        body.retro-dark-theme {
            --bg-color: #333333;
            --code-bg-color: #222222;
            --text-color: #f0f0f0;
            --border-color: #f0f0f0;
            --op-bg-color: #333333;
            --op-text-color: #f0f0f0;
            --loop-color: #800000;
            font-family: 'MS Sans Serif', 'Arial', 'Monospace', sans-serif !important;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Monospace', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        #globalTitle {
            font-size: 1.5em;
            margin: 0 0 20px 0;
            font-weight: bold;
            color: var(--text-color);
            align-self: flex-start;
            width: 100%;
            text-align: center;
            margin-left: 10px;
        }

        .main-layout {
            width: 100%;
            max-width: 1400px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding-top: 0;
        }

        .controls-code-column {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        #visualizer-container {
            width: 100%;
            margin-bottom: 30px; 
            box-sizing: border-box;
        }

        #visualizer {
            background-color: var(--code-bg-color);
            border: 1.7px solid var(--border-color);
            width: 100%;
            height: 100px;
            box-sizing: border-box;
        }

        .controls-container {
            background-color: var(--bg-color);
            border: 1.7px solid var(--border-color);
            padding: 20px;
            border-radius: 0;
            width: 100%;
            box-sizing: border-box;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .value-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        input[type="range"] {
            flex-grow: 1;
            margin: 0;
            -webkit-appearance: none;
            background: var(--border-color);
            height: 2px;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 0;
            background: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .value-input, select {
            width: 70px;
            padding: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 0.9em;
            text-align: right;
            border-radius: 4px;
        }
        
        select {
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            text-align: left;
            text-align-last: left;
            min-width: 120px;
        }

        .action-button-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #playBtn {
            flex-grow: 1;
            padding: 10px 20px;
            font-size: 1.1em;
            background-color: var(--op-bg-color);
            color: var(--op-text-color);
            border: 2px solid var(--border-color);
            cursor: pointer;
            font-family: inherit;
            border-radius: 8px;
            transition: all 0.1s;
        }

        #loopBtn, #shuffleVisualizerBtn {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.1em;
            background-color: var(--op-bg-color);
            color: var(--op-text-color);
            border: 2px solid var(--border-color);
            cursor: pointer;
            font-family: inherit;
            border-radius: 50%; 
            flex-shrink: 0;
            transition: all 0.1s;
        }

        #loopBtn.active {
            background-color: var(--loop-color);
            color: var(--op-bg-color);
            border-color: var(--loop-color);
        }
        
        #playBtn:active:not(:disabled), #loopBtn:active:not(.active), #shuffleVisualizerBtn:active {
            filter: invert(100%);
        }
        #loopBtn.active:active {
            filter: brightness(80%);
        }
        #playBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #codeOutputContainer {
            background-color: var(--code-bg-color);
            border: 2px solid var(--border-color);
            padding: 15px;
            border-radius: 0;
            width: 100%;
            margin-top: 30px;
            margin-bottom: 0; 
            box-sizing: border-box;
            transition: all 0.3s ease-in-out;
        }
        
        #codeOutputContainer.minimized {
            height: 50px; 
            overflow: hidden;
            padding: 0 15px;
        }

        #codeHeader {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            cursor: pointer;
            user-select: none;
            height: 100%; 
            border-bottom: 1px solid var(--border-color);
        }

        #codeOutputContainer.minimized #codeHeader {
             border-bottom: none; 
        }
        
        #codeHeader div {
            display: flex;
            gap: 10px;
            height: 100%; 
            align-items: center; 
        }

        #codeOutput {
            width: 100%;
            height: 250px;
            border: none;
            background: none;
            color: var(--text-color);
            font-family: 'Monospace', monospace;
            font-size: 12px;
            resize: vertical;
            padding: 10px 0 0 0;
            box-sizing: border-box;
            line-height: 1.4;
            display: block;
            border-radius: 0;
            transition: all 0.2s;
        }

        .code-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px; 
            background-color: transparent; 
            border: 1.5px solid var(--border-color); 
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-family: 'Monospace', monospace;
            box-sizing: border-box;
            font-size: 14px;
            line-height: 1;
            transition: all 0.3s;
        }
        
        .code-action-btn:active {
            filter: invert(100%);
        }

        .side-buttons-container {
            position: fixed;
            top: 20px;
            z-index: 1000; 
            display: flex;
            flex-direction: row;
            gap: 10px;
            transition: left 0.5s, right 0.5s;
        }

        .side-buttons-container.right {
            right: 20px;
            left: unset;
        }
        
        .side-buttons-container.left {
            left: 20px;
            right: unset;
        }
        
        .side-buttons-container .action-btn {
            width: 40px;
            height: 40px;
            font-size: 18px;
            border-radius: 50%;
            background-color: var(--op-bg-color);
            border: 1.7px solid var(--op-bg-color); 
            color: var(--op-text-color);
            transform-origin: center center;
            transition: all 0.1s;
        }

        .corner-button {
            position: fixed;
            top: 0; 
            width: 25vw; 
            height: 5vh;
            z-index: 999; 
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        #leftCornerBtn {
            left: 0;
        }
        
        #rightCornerBtn {
            right: 0;
        }

        .animate-spin-out {
            animation: spinShrinkDisappear 0.5s forwards;
        }
        
        .animate-spin-in {
            animation: spinGrowAppear 0.5s forwards;
        }

        @keyframes spinShrinkDisappear {
            0% { transform: rotate(0deg) scale(1); opacity: 1; }
            100% { transform: rotate(-720deg) scale(0); opacity: 0; }
        }
        
        @keyframes spinGrowAppear {
            0% { transform: rotate(0deg) scale(0); opacity: 0; }
            14% { transform: rotate(0deg) scale(0.1); opacity: 0; }
            100% { transform: rotate(720deg) scale(1); opacity: 1; }
        }
        
        #codeModalBackdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #codeModalBackdrop.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        #codeModalPanel {
            position: relative;
            width: 80%;
            max-width: 650px;
            max-height: 80vh;
            overflow: hidden;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            transition: all 0.3s ease-in-out;
            transform: scale(0.95);
            display: flex;
            flex-direction: column;
        }

        body.light-theme #codeModalPanel {
            background-color: rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(0, 0, 0, 0.3);
        }

        #codeModalBackdrop.visible #codeModalPanel {
            transform: scale(1);
        }

        #codeModalPanel #codeOutputContainer {
            margin-top: 0 !important;
            padding: 0 !important;
            border: none !important;
            background-color: transparent !important;
            max-height: 100%;
        }

        #codeModalPanel #codeOutput {
            height: calc(80vh - 100px);
            resize: none !important;
            overflow: auto;
        }
        
        .retro-light-theme *, .retro-dark-theme * { transition: none !important; }
        .retro-light-theme button, .retro-dark-theme button,
        .retro-light-theme .code-action-btn, .retro-dark-theme .code-action-btn {
            border-radius: 0;
            border-style: outset;
            border-width: 2px;
            filter: none !important;
        }
        .retro-light-theme .side-buttons-container .action-btn, .retro-dark-theme .side-buttons-container .action-btn { border-radius: 0; border-style: outset; }
        .retro-light-theme button:active:not(:disabled), .retro-dark-theme button:active:not(:disabled), #shuffleVisualizerBtn:active:not(:disabled) { border-style: inset; }
        .retro-light-theme #shuffleVisualizerBtn:active:not(:disabled) { border-style: groove; background-color: black; }
        .retro-dark-theme #shuffleVisualizerBtn:active:not(:disabled) { border-style: groove; background-color: white; }
        .retro-light-theme #playBtn { border-radius: 0; border-style: outset; border-width: 2px; background-color: #dedede; color: black;}
		.retro-dark-theme #playBtn { border-radius: 0; border-style: outset; border-width: 2px; background-color: #121212; color: white;}
        .retro-light-theme #loopBtn, .retro-dark-theme #loopBtn,
        .retro-light-theme #shuffleVisualizerBtn, .retro-dark-theme #shuffleVisualizerBtn { 
            border-radius: 0; border-style: outset; border-width: 2px; background-color: var(--op-bg-color); color: var(--op-text-color); border-color: var(--border-color);
        }
        .retro-light-theme #loopBtn.active, .retro-dark-theme #loopBtn.active { border-style: outset; background-color: var(--loop-color); color: white; border-color: var(--border-color); }
        .retro-light-theme .controls-container { border-radius: 0; border-style: groove; border-width: 2.5px;}
		.retro-dark-theme .controls-container { border-radius: 0; border-style: outset; border-width: 2.5px; border-color: var(--border-color);}
        .retro-light-theme #visualizer-container, .retro-dark-theme #visualizer-container,
        .retro-light-theme #codeOutputContainer, .retro-dark-theme #codeOutputContainer {
            border-style: inset;
            border-width: 2.2px;
        }
        .retro-light-theme #visualizer, .retro-dark-theme #visualizer { border: 1px solid var(--border-color); }
        .retro-light-theme input[type="text"], .retro-dark-theme input[type="text"],
        .retro-light-theme input[type="number"], .retro-dark-theme input[type="number"],
        .retro-light-theme select, .retro-dark-theme select {
            border-radius: 0;
            border-style: inset;
            border-width: 2px;
            background-color: var(--code-bg-color);
        }
        .retro-light-theme #codeModalPanel, .retro-dark-theme #codeModalPanel {
            border-radius: 0;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            background-color: var(--bg-color);
            border: 2px outset var(--border-color);
            box-shadow: none;
        }
        .retro-light-theme { --border-3d-light: #ffffff; --border-3d-dark: #808080; }
        .retro-dark-theme { --border-3d-light: #555555; --border-3d-dark: #111111; }
        .retro-light-theme .controls-container, .retro-dark-theme .controls-container,
        .retro-light-theme #visualizer-container, .retro-dark-theme #visualizer-container,
        .retro-light-theme #codeOutputContainer, .retro-dark-theme #codeOutputContainer,
        .retro-light-theme select, .retro-dark-theme select,
        .retro-light-theme .value-input, .retro-dark-theme .value-input {
            border-color: var(--border-3d-dark) var(--border-3d-light) var(--border-3d-light) var(--border-3d-dark);
        }
        .retro-light-theme button, .retro-dark-theme button,
        .retro-light-theme .code-action-btn, .retro-dark-theme .code-action-btn {
            border-color: var(--border-3d-light) var(--border-3d-dark) var(--border-3d-dark) var(--border-3d-light);
        }
        .retro-light-theme button:active, .retro-dark-theme button:active,
        .retro-light-theme #loopBtn.active, .retro-dark-theme #loopBtn.active {
            border-color: var(--border-3d-dark) var(--border-3d-light) var(--border-3d-light) var(--border-3d-dark);
        }


        @media (min-width: 769px) {
            body {
                padding: 40px;
            }
            #globalTitle {
                margin: 0 0 40px 0;
                align-self: center;
                text-align: center;
                max-width: 1400px;
            }

            .main-layout {
                flex-direction: column; 
                align-items: center;
                gap: 0;
            }

            .controls-code-column {
                display: flex;
                flex-direction: row; 
                gap: 50px;
                max-width: 1050px;
                width: 100%;
                padding-top: 20px;
            }
            
            #visualizer-container {
                order: 1; 
                width: 450px;
                max-width: 450px;
                height: 490px; 
                margin-top: 20px;
                padding: 0;
                flex-shrink: 0;
                align-self: flex-start;
                border: 2px solid var(--border-color);
            }
            #visualizer {
                height: 100%;
                border: none;
            }

            .controls-group-right {
                order: 2; 
                display: flex;
                flex-direction: column; 
                gap: 30px;
                width: 550px;
                max-width: 550px;
                flex-grow: 1;
                padding-top: 20px; 
            }

            .controls-container {
                grid-template-columns: 1fr 1fr;
                gap: 15px 20px;
                border: 2px solid var(--border-color);
                margin-top: 0;
                border-top: 2px solid var(--border-color);
                order: 1;
            }
            
            #codeOutputContainer {
                order: 2;
                margin-top: 0;
                width: 100%;
            }
            
            #codeOutput {
                height: 250px; 
            }

            #codeOutputContainer:not(.is-modal) {
                height: 50px !important;
                overflow: hidden !important;
                padding: 10px !important;
                border-top: 2px solid var(--border-color) !important;
            }
            #codeOutputContainer:not(.is-modal) #codeOutput {
                display: none !important;
            }
            #codeOutputContainer:not(.is-modal) #codeHeader {
                border-bottom: none !important;
                padding: 0px; 
            }

            .value-input, select {
                width: 50px; 
            }
            
            .value-input-group {
                gap: 5px; 
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 10px 100px 10px; 
            }
            
            #globalTitle {
                margin-left: 10px; 
                margin-bottom: 15px;
            }
            
            .side-buttons-container {
                top: 5px;
                left: 10px;
                right: unset;
                bottom: unset;
            }
            
            .side-buttons-container.right {
                right: 10px;
                left: unset;
            }
            
            .side-buttons-container .action-btn {
                width: 35px;
                height: 35px;
            }
            
            .controls-code-column {
                flex-direction: column; 
                gap: 0;
                max-width: 100%;
                width: 100%;
            }

            #visualizer-container {
                order: -1; 
                margin-bottom: 0; 
                padding: 10px;
                border: 1.7px solid var(--border-color);
                border-bottom: none;
                height: 150px;
                max-width: 100%;
            }
            #visualizer {
                height: 100%;
                border: none;
            }

            .controls-container {
                order: 0; 
                grid-template-columns: 1fr 1fr; 
                padding: 20px 10px;
                gap: 12px 10px;
                border-top: none; 
            }
            
            .controls-container > .control-group:nth-child(n+3), 
            .action-button-group {
                grid-column: 1 / -1; 
            }

            #codeOutputContainer {
                margin-top: 30px;
            }
            
            .value-input, select {
                width: 70px;
            }
        }
    </style>
</head>
<body id="body">

    <h1 id="globalTitle">./SYNTH.</h1>

    <div class="main-layout">
        <div class="controls-code-column">
            
            <div id="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>

            <div class="controls-group-right"> 
                <div class="controls-container">
                    
                    <div class="control-group">
                        <label for="waveType">Wave Type</label>
                        <select id="waveType" oninput="saveSettings(); generateCode(); if (isLooping) playCustomSound();"></select>
                    </div>

                    <div class="control-group">
                        <label for="filterType">Filter Type</label>
                        <select id="filterType" oninput="saveSettings(); generateCode(); if (isLooping) playCustomSound();"></select>
                    </div>

                    <div class="control-group">
                        <label for="startFreq">Start Frequency (Hz)</label>
                        <div class="value-input-group">
                            <input type="range" id="startFreq" min="50" max="4000" step="1" value="1000" data-link="startFreqInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="startFreqInput" class="value-input" min="50" max="4000" step="1" value="1000" data-link="startFreq" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="endFreq">End Frequency (Hz)</label>
                        <div class="value-input-group">
                            <input type="range" id="endFreq" min="50" max="4000" step="1" value="1000" data-link="endFreqInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="endFreqInput" class="value-input" min="50" max="4000" step="1" value="1000" data-link="endFreq" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="audioDuration">Audio Duration (s)</label>
                        <div class="value-input-group">
                            <input type="range" id="audioDuration" min="0.1" max="5.0" step="0.1" value="0.7" data-link="audioDurationInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="audioDurationInput" class="value-input" min="0.1" max="5.0" step="0.1" value="0.7" data-link="audioDuration" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="decayTime">Decay Time (s)</label>
                        <div class="value-input-group">
                            <input type="range" id="decayTime" min="0.01" max="0.5" step="0.01" value="0.07" data-link="decayTimeInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="decayTimeInput" class="value-input" min="0.01" max="0.5" step="0.01" value="0.07" data-link="decayTime" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="attackTime">Attack Time (s)</label>
                        <div class="value-input-group">
                            <input type="range" id="attackTime" min="0.001" max="0.1" step="0.001" value="0.005" data-link="attackTimeInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="attackTimeInput" class="value-input" min="0.001" max="0.1" step="0.001" value="0.005" data-link="attackTime" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="filterFreq">Filter Frequency (Hz)</label>
                        <div class="value-input-group">
                            <input type="range" id="filterFreq" min="20" max="4000" step="1" value="4000" data-link="filterFreqInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="filterFreqInput" class="value-input" min="20" max="4000" step="1" value="4000" data-link="filterFreq" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="filterQ">Filter Q (Resonance)</label>
                        <div class="value-input-group">
                            <input type="range" id="filterQ" min="0.1" max="30" step="0.1" value="1.0" data-link="filterQInput" oninput="linkSlider(this); generateCode(); if (isLooping) playCustomSound();">
                            <input type="number" id="filterQInput" class="value-input" min="0.1" max="30" step="0.1" value="1.0" data-link="filterQ" oninput="linkInput(this); generateCode(); if (isLooping) playCustomSound();">
                        </div>
                    </div>

                    <div class="action-button-group">
                        <button id="loopBtn" onclick="toggleLoop()"><b>∞</b></button>
                        <button id="shuffleVisualizerBtn" onclick="shuffleVisualizer()"><b>⌘</b></button>
                        <button id="playBtn" onclick="playCustomSound()">SOUND</button>
                    </div>
                </div>

                <div id="codeOutputContainer" class="minimized">
                    <div id="codeHeader" onclick="toggleCodeView()">
                        <span style="font-size: 1.1em;">Code Script (.js) </span>
                        <div>
                            <button class="code-action-btn" id="editBtn" onclick="editCode(event)">⌨</button>
                            <button class="code-action-btn" onclick="copyCode(event)">⛶</button>
                        </div>
                    </div>
                    <textarea id="codeOutput" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="side-buttons-container left" id="sideButtons">
        <button class="action-btn" id="resetBtn" onclick="resetButtonAction(event)">⊘</button>
        <button class="action-btn" id="themeToggleBtn" onclick="toggleTheme()">⽉</button>
        <button class="action-btn" id="exportBtn" onclick="exportAudio(event)">E</button>
    </div>

    <div class="corner-button" id="leftCornerBtn"></div>
    <div class="corner-button" id="rightCornerBtn"></div>

    <div id="codeModalBackdrop" class="hidden">
        <div id="codeModalPanel">
        </div>
    </div>

    <footer style="z-index: 5; text-align: center; margin-top: 20px; color: #555; padding: 10px; position: relative;"><span id="revealTrigger" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer; z-index: 15; opacity: 0; pointer-events: none;"></span><a href="https://xetsue.github.io/" target="_blank" rel="noopener noreferrer" id="targetLink" style="color: inherit; text-decoration: none; opacity: 1; pointer-events: auto; transition: opacity 0.5s ease-in-out; z-index: 10;">xetsue.github.io</a></footer><script>document.addEventListener('DOMContentLoaded', function() { const trigger = document.getElementById('revealTrigger'); const link = document.getElementById('targetLink'); const hideLink = () => { link.style.opacity = '0'; link.style.pointerEvents = 'none'; trigger.style.opacity = '1'; trigger.style.pointerEvents = 'auto'; }; setTimeout(hideLink, 1500); trigger.addEventListener('click', function() { link.style.opacity = '1'; link.style.pointerEvents = 'auto'; trigger.style.opacity = '0'; trigger.style.pointerEvents = 'none'; setTimeout(hideLink, 2000); }); });</script>
    
    <script>
        let audioContext;
        let analyser;
        let animationFrameId = null;
        let isLooping = false; 
        let currentSound = null;
        let originalCodeContainerParent = null;

        const DEFAULTS = {
            waveType: 'sine',
            filterType: 'lowpass',
            startFreq: 1000,
            endFreq: 1000,
            audioDuration: 0.7, 
            decayTime: 0.07,
            attackTime: 0.005,
            filterFreq: 4000,
            filterQ: 1.0
        };

        const WAVE_OPTIONS = ['sine', 'square', 'sawtooth', 'triangle'];
        const FILTER_OPTIONS = ['lowpass', 'highpass', 'bandpass', 'notch'];
        const THEMES = ['default', 'light-theme', 'retro-dark-theme', 'retro-light-theme'];
        const VISUALIZER_TYPES = ['bars', 'line', 'circle'];
        let currentThemeIndex = 0;
        let currentVisualizerIndex = 0;

        function initSelects() {
            const waveSelect = document.getElementById('waveType');
            const filterSelect = document.getElementById('filterType');
            WAVE_OPTIONS.forEach(opt => waveSelect.options.add(new Option(opt.charAt(0).toUpperCase() + opt.slice(1), opt)));
            FILTER_OPTIONS.forEach(opt => filterSelect.options.add(new Option(opt.charAt(0).toUpperCase() + opt.slice(1), opt)));
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSelects();
            loadSettings();
            generateCode();
            
            const sideButtons = document.getElementById('sideButtons');
            const storedSide = localStorage.getItem('synthButtonSide') || 'left'; 
            
            sideButtons.classList.remove('left', 'right');
            sideButtons.classList.add(storedSide);
            
            const codeOutputContainer = document.getElementById('codeOutputContainer');
            originalCodeContainerParent = codeOutputContainer.parentElement;
            
            if (window.innerWidth < 769) {
                 codeOutputContainer.classList.add('minimized');
                 document.getElementById('codeOutput').style.display = 'none';
            }

            const savedVisualizer = localStorage.getItem('synthVisualizerType') || 'bars';
            currentVisualizerIndex = VISUALIZER_TYPES.indexOf(savedVisualizer);
            if (currentVisualizerIndex === -1) currentVisualizerIndex = 0;
            drawBlankVisualizer();

            document.getElementById('leftCornerBtn').addEventListener('click', () => {
                if (sideButtons.classList.contains('right')) { 
                    toggleButtonSide('left');
                }
            });

            document.getElementById('rightCornerBtn').addEventListener('click', () => {
                if (sideButtons.classList.contains('left')) { 
                    toggleButtonSide('right');
                }
            });
            
            const storedLoop = localStorage.getItem('synthLoop') === 'true';
            isLooping = storedLoop;
            document.getElementById('loopBtn').classList.toggle('active', isLooping);
            document.getElementById('playBtn').disabled = isLooping;

            const savedTheme = localStorage.getItem('synthTheme') || 'default';
            currentThemeIndex = THEMES.indexOf(savedTheme);
            if (currentThemeIndex === -1) currentThemeIndex = 0;
            const themeClass = THEMES[currentThemeIndex];
            if (themeClass !== 'default') {
                document.body.classList.add(themeClass);
            }
        });

        function shuffleVisualizer() {
            currentVisualizerIndex = (currentVisualizerIndex + 1) % VISUALIZER_TYPES.length;
            localStorage.setItem('synthVisualizerType', VISUALIZER_TYPES[currentVisualizerIndex]);
            if (!currentSound) {
                drawBlankVisualizer();
            }
        }

        function drawBlankVisualizer() {
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const style = getComputedStyle(document.body);
            const bgColor = style.getPropertyValue('--code-bg-color');
            canvasCtx.fillStyle = bgColor;
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function initContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext.currentTime;
        }

        function linkSlider(slider) {
            document.getElementById(slider.dataset.link).value = slider.value;
            saveSettings();
        }
        
        function linkInput(input) {
            document.getElementById(input.dataset.link).value = input.value;
            saveSettings();
        }

        function openCodeModal() {
            const backdrop = document.getElementById('codeModalBackdrop');
            const panel = document.getElementById('codeModalPanel');
            const codeOutputContainer = document.getElementById('codeOutputContainer');
            
            codeOutputContainer.classList.add('is-modal');
            panel.appendChild(codeOutputContainer);
            
            backdrop.classList.remove('hidden');
            backdrop.classList.add('visible');

            backdrop.addEventListener('click', closeModalOutside, false);

            codeOutputContainer.classList.remove('minimized');
            document.getElementById('codeOutput').style.display = 'block';
            document.getElementById('codeHeader').style.borderBottom = '1px solid var(--border-color)';
            document.getElementById('codeOutput').readOnly = true;
            document.getElementById('editBtn').textContent = '⌨';
        }

        function closeModalOutside(event) {
            if (event.target === document.getElementById('codeModalBackdrop')) {
                closeCodeModal();
            }
        }

        function closeCodeModal() {
            const backdrop = document.getElementById('codeModalBackdrop');
            const codeOutputContainer = document.getElementById('codeOutputContainer');

            backdrop.classList.remove('visible');
            backdrop.classList.add('hidden');
            backdrop.removeEventListener('click', closeModalOutside, false);

            if (originalCodeContainerParent) {
                originalCodeContainerParent.appendChild(codeOutputContainer);
            }
            codeOutputContainer.classList.remove('is-modal');
            
            if (window.innerWidth >= 769) {
                 codeOutputContainer.classList.add('minimized');
                 document.getElementById('codeOutput').style.display = 'none';
            }
        }

        function toggleCodeView() {
            if (window.innerWidth >= 769) {
                const backdrop = document.getElementById('codeModalBackdrop');
                if (backdrop.classList.contains('visible')) {
                    closeCodeModal();
                } else {
                    openCodeModal();
                }
            } else {
                const container = document.getElementById('codeOutputContainer');
                const header = document.getElementById('codeHeader');
                if (container.classList.contains('minimized')) {
                    container.classList.remove('minimized');
                    document.getElementById('codeOutput').style.display = 'block';
                    header.style.borderBottom = '1px solid var(--border-color)';
                } else {
                    document.getElementById('codeOutput').style.display = 'none';
                    container.classList.add('minimized');
                    header.style.borderBottom = 'none';
                }
            }
        }

        function stopCurrentSound() {
             if (currentSound && currentSound.osc) {
                try {
                    currentSound.osc.stop();
                } catch (e) {}
                currentSound.osc.disconnect();
                currentSound = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            drawBlankVisualizer();
        }

        function toggleLoop() {
            isLooping = !isLooping;
            localStorage.setItem('synthLoop', isLooping);
            document.getElementById('loopBtn').classList.toggle('active', isLooping);
            document.getElementById('playBtn').disabled = isLooping;

            if (!isLooping) {
                stopCurrentSound();
            } else {
                 playCustomSound();
            }
        }
        
        function playCustomSound() {
            const playBtn = document.getElementById('playBtn');
            if (!isLooping && playBtn.disabled) return;

            if (isLooping && currentSound && audioContext) {
                const fadeOutTime = 0.015;
                const nowForFade = audioContext.currentTime;
                currentSound.gain.gain.cancelScheduledValues(nowForFade);
                currentSound.gain.gain.setValueAtTime(currentSound.gain.gain.value, nowForFade);
                currentSound.gain.gain.linearRampToValueAtTime(0, nowForFade + fadeOutTime);
                currentSound.osc.stop(nowForFade + fadeOutTime);
            } else {
                stopCurrentSound();
            }
            
            if (!isLooping) {
                playBtn.disabled = true;
            }

            const now = initContext();
            const settings = getSettingsFromUI();
            
            const osc = audioContext.createOscillator();
            const filter = audioContext.createBiquadFilter();
            const gain = audioContext.createGain();

            osc.type = settings.waveType;
            filter.type = settings.filterType;
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(analyser);
            analyser.connect(audioContext.destination);
            
            filter.frequency.setValueAtTime(settings.filterFreq, now);
            filter.Q.setValueAtTime(settings.filterQ, now);

            if (isLooping) {
                osc.loop = true; 
                osc.loopStart = 0;
                osc.loopEnd = settings.audioDuration;

                osc.frequency.setValueAtTime(settings.startFreq, now); 
                osc.frequency.linearRampToValueAtTime(settings.endFreq, now + settings.audioDuration);
                
                gain.gain.setValueAtTime(0.0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + 0.01);
                gain.gain.setTargetAtTime(0.5, now + 0.01, 0.001); 
                
                osc.start(now);
                
            } else {
                osc.loop = false;
                
                osc.frequency.setValueAtTime(settings.startFreq, now);
                osc.frequency.linearRampToValueAtTime(settings.endFreq, now + settings.audioDuration);
                
                gain.gain.setValueAtTime(0.0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + settings.attackTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + settings.audioDuration);
                
                osc.start(now);
                osc.stop(now + settings.audioDuration + 0.05);

                osc.onended = () => {
                    playBtn.disabled = false;
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    drawBlankVisualizer();
                    osc.disconnect();
                    filter.disconnect();
                    gain.disconnect();
                    currentSound = null;
                };
            }
            
            currentSound = { osc, filter, gain }; 
            visualize();
        }

        function getSettingsFromUI() {
            return {
                waveType: document.getElementById('waveType').value,
                filterType: document.getElementById('filterType').value,
                startFreq: parseFloat(document.getElementById('startFreqInput').value),
                endFreq: parseFloat(document.getElementById('endFreqInput').value),
                audioDuration: parseFloat(document.getElementById('audioDurationInput').value), 
                decayTime: parseFloat(document.getElementById('decayTimeInput').value),
                attackTime: parseFloat(document.getElementById('attackTimeInput').value),
                filterFreq: parseFloat(document.getElementById('filterFreqInput').value),
                filterQ: parseFloat(document.getElementById('filterQInput').value)
            };
        }
        
        function bufferToWav(buffer, opt) {
            opt = opt || {};
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = opt.float32 ? 3 : 1;
            const bitDepth = format === 3 ? 32 : 16;
            let result;
            if (numChannels === 2) {
                result = interleave(buffer.getChannelData(0), buffer.getChannelData(1));
            } else {
                result = buffer.getChannelData(0);
            }
            return encodeWAV(result, format, sampleRate, numChannels, bitDepth);
        }

        function encodeWAV(samples, format, sampleRate, numChannels, bitDepth) {
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            const buffer = new ArrayBuffer(44 + samples.length * bytesPerSample);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * bytesPerSample, true);
            if (format === 1) {
                floatTo16BitPCM(view, 44, samples);
            } else {
                writeFloat32(view, 44, samples);
            }
            return view;
        }

        function interleave(inputL, inputR) {
            const length = inputL.length + inputR.length;
            const result = new Float32Array(length);
            let index = 0, inputIndex = 0;
            while (index < length) {
                result[index++] = inputL[inputIndex];
                result[index++] = inputR[inputIndex];
                inputIndex++;
            }
            return result;
        }

        function writeFloat32(output, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 4) {
                output.setFloat32(offset, input[i], true);
            }
        }

        function floatTo16BitPCM(output, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 2) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function exportAudio(e) {
            e.stopPropagation();
            const btn = document.getElementById('exportBtn');
            const originalText = btn.textContent;
            btn.textContent = '…';
            btn.disabled = true;

            const settings = getSettingsFromUI();
            const totalDuration = settings.audioDuration + 0.05;
            const sampleRate = 44100;
            const offlineCtx = new OfflineAudioContext(1, sampleRate * totalDuration, sampleRate);
            
            const now = offlineCtx.currentTime;

            const osc = offlineCtx.createOscillator();
            const filter = offlineCtx.createBiquadFilter();
            const gain = offlineCtx.createGain();

            osc.type = settings.waveType;
            filter.type = settings.filterType;
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(offlineCtx.destination);
            
            filter.frequency.setValueAtTime(settings.filterFreq, now);
            filter.Q.setValueAtTime(settings.filterQ, now);

            osc.frequency.setValueAtTime(settings.startFreq, now);
            osc.frequency.linearRampToValueAtTime(settings.endFreq, now + settings.audioDuration);
            
            gain.gain.setValueAtTime(0.0, now);
            gain.gain.linearRampToValueAtTime(0.5, now + settings.attackTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + settings.audioDuration);
            
            osc.start(now);
            
            try {
                const renderedBuffer = await offlineCtx.startRendering();
                const wav = bufferToWav(renderedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });

                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(blob);
                a.download = 'synth.wav';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(a.href);
                document.body.removeChild(a);

            } catch(err) {
                alert('An error occurred while exporting the audio.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function drawBars(canvasCtx, dataArray, W, H, color) {
            const bufferLength = dataArray.length;
            const barWidth = (W / bufferLength) * 2.5;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * H;
                canvasCtx.fillStyle = color;
                canvasCtx.fillRect(x, H - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        function drawLine(canvasCtx, dataArray, W, H, color) {
            const bufferLength = dataArray.length;
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = color;
            canvasCtx.beginPath();
            const sliceWidth = W * 1.0 / bufferLength;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * H / 2;
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            canvasCtx.lineTo(W, H / 2);
            canvasCtx.stroke();
        }

        function drawCircle(canvasCtx, dataArray, W, H, color) {
            const bufferLength = dataArray.length;
            const centerX = W / 2;
            const centerY = H / 2;
            const radius = Math.min(W, H) / 3.5;
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = color;
            canvasCtx.beginPath();

            for (let i = 0; i < bufferLength; i++) {
                const angle = (i / bufferLength) * 2 * Math.PI;
                const barHeight = (dataArray[i] / 255) * radius * 0.8;
                const x = centerX + Math.cos(angle) * (radius + barHeight);
                const y = centerY + Math.sin(angle) * (radius + barHeight);

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            canvasCtx.closePath();
            canvasCtx.stroke();
        }


        function visualize() {
            if (!analyser) return;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }

            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const style = getComputedStyle(document.body);
            const bgColor = style.getPropertyValue('--code-bg-color');
            const textColor = style.getPropertyValue('--text-color');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            analyser.fftSize = 2048;
            const visualizerType = VISUALIZER_TYPES[currentVisualizerIndex];
            const bufferLength = (visualizerType === 'bars' || visualizerType === 'circle') ? analyser.frequencyBinCount / 2 : analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);
            
            const draw = () => {
                if (!currentSound) {
                     if (animationFrameId) cancelAnimationFrame(animationFrameId);
                     animationFrameId = null;
                     drawBlankVisualizer();
                     return;
                }

                animationFrameId = requestAnimationFrame(draw);
                
                if (visualizerType === 'line') {
                    analyser.getByteTimeDomainData(dataArray);
                } else {
                    analyser.getByteFrequencyData(dataArray);
                }
                
                canvasCtx.fillStyle = bgColor;
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                switch (visualizerType) {
                    case 'line':
                        drawLine(canvasCtx, dataArray, canvas.width, canvas.height, textColor);
                        break;
                    case 'circle':
                        drawCircle(canvasCtx, dataArray, canvas.width, canvas.height, textColor);
                        break;
                    default:
                        drawBars(canvasCtx, dataArray, canvas.width, canvas.height, textColor);
                        break;
                }
            };
            
            draw();
        }

        function generateCode() {
            const s = getSettingsFromUI();
            const code = `
function createCustomTone(audioContext, isLooped = false) {
    const now = audioContext.currentTime;
    const osc = audioContext.createOscillator();
    const filter = audioContext.createBiquadFilter();
    const gain = audioContext.createGain();

    const WAVE_TYPE = '${s.waveType}';
    const FILTER_TYPE = '${s.filterType}';
    const START_FREQ = ${s.startFreq.toFixed(3)};
    const END_FREQ = ${s.endFreq.toFixed(3)};
    const DURATION = ${s.audioDuration.toFixed(3)};
    const ATTACK_TIME = ${s.attackTime.toFixed(3)};
    const FILTER_FREQ = ${s.filterFreq.toFixed(3)};
    const FILTER_Q = ${s.filterQ.toFixed(3)};
    
    osc.type = WAVE_TYPE;
    filter.type = FILTER_TYPE;

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(audioContext.destination);
    
    filter.frequency.setValueAtTime(FILTER_FREQ, now);
    filter.Q.setValueAtTime(FILTER_Q, now);

    if (isLooped) {
        osc.loop = true;
        osc.loopStart = 0;
        osc.loopEnd = DURATION;
        osc.frequency.setValueAtTime(START_FREQ, now); 
        osc.frequency.linearRampToValueAtTime(END_FREQ, now + DURATION);
        gain.gain.setValueAtTime(0.0, now);
        gain.gain.linearRampToValueAtTime(0.5, now + ATTACK_TIME);
        gain.gain.setTargetAtTime(0.5, now + ATTACK_TIME, 0.001); 
    } else {
        osc.loop = false;
        osc.frequency.setValueAtTime(START_FREQ, now);
        osc.frequency.linearRampToValueAtTime(END_FREQ, now + DURATION);
        gain.gain.setValueAtTime(0.0, now);
        gain.gain.linearRampToValueAtTime(0.5, now + ATTACK_TIME);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + DURATION);
    }

    osc.start(now);
    if (!isLooped) {
        osc.stop(now + DURATION + 0.05);
    }
    osc.onended = () => {
        osc.disconnect();
        filter.disconnect();
        gain.disconnect();
    };
    return osc;
}
`.trim();
            document.getElementById('codeOutput').value = code;
        }

        function copyCode(e) {
            e.stopPropagation();
            const codeOutput = document.getElementById('codeOutput');
            const isHidden = codeOutput.style.display === 'none';
            if (isHidden) codeOutput.style.display = 'block';
            codeOutput.select();
            document.execCommand('copy');
            if (isHidden) codeOutput.style.display = 'none';
            const btn = e.target;
            const originalText = btn.textContent;
            btn.textContent = '☻';
            setTimeout(() => { btn.textContent = originalText; }, 1000);
        }
        
        function editCode(e) {
            e.stopPropagation();
            const codeOutput = document.getElementById('codeOutput');
            const editBtn = document.getElementById('editBtn');

            if (codeOutput.readOnly) {
                codeOutput.readOnly = false;
                editBtn.textContent = '⎗'; 
                if (document.getElementById('codeOutputContainer').classList.contains('minimized')) {
                    toggleCodeView();
                }
            } else {
                const settings = parseCode(codeOutput.value);
                if (settings) {
                    loadSettings(settings); 
                    generateCode(); 
                    editBtn.textContent = '⌨';
                    codeOutput.readOnly = true;
                    alert('Settings loaded from script!');
                } else {
                    alert('Could not parse settings from script.');
                }
            }
        }
        
        function parseCode(code) {
            const settings = {};
            const regex = /const ([A-Z_]+) = (.+);/g;
            let match;
            while ((match = regex.exec(code)) !== null) {
                const name = match[1].toLowerCase().replace(/_(\w)/g, (m, c) => c.toUpperCase());
                let value = match[2].trim().replace(/[';]/g, '');
                if (!isNaN(parseFloat(value))) {
                    value = parseFloat(value);
                }
                settings[name] = value;
            }
            return (Object.keys(settings).length >= 8) ? settings : null;
        }

        function toggleTheme() {
            const btn = document.getElementById('themeToggleBtn');
            btn.classList.add('animate-spin-out');
            setTimeout(() => {
                currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
                const newTheme = THEMES[currentThemeIndex];
                document.body.classList.remove(...THEMES.filter(t => t !== 'default'));
                if (newTheme !== 'default') {
                    document.body.classList.add(newTheme);
                }
                localStorage.setItem('synthTheme', newTheme);
                drawBlankVisualizer(); 
                btn.classList.remove('animate-spin-out');
                btn.classList.add('animate-spin-in');
                setTimeout(() => btn.classList.remove('animate-spin-in'), 500);
            }, 500); 
        }

        function toggleButtonSide(targetDirection) {
            const container = document.getElementById('sideButtons');
            const currentSide = container.classList.contains('right') ? 'right' : 'left';
            if (targetDirection === currentSide) return;

            const buttons = container.querySelectorAll('.action-btn');
            buttons.forEach(btn => btn.classList.add('animate-spin-out'));
            
            setTimeout(() => {
                container.classList.remove('right', 'left');
                container.classList.add(targetDirection);
                localStorage.setItem('synthButtonSide', targetDirection);
                buttons.forEach(btn => {
                    btn.classList.remove('animate-spin-out');
                    btn.classList.add('animate-spin-in');
                });
                setTimeout(() => buttons.forEach(btn => btn.classList.remove('animate-spin-in')), 500); 
            }, 500);
        }
        
        function resetButtonAction(e) {
            e.stopPropagation();
            if (confirm('Are you sure you want to reset all synthesizer settings to default?')) {
                localStorage.removeItem('synthSettings');
                loadSettings(DEFAULTS);
                generateCode();
                stopCurrentSound();
                document.getElementById('playBtn').disabled = false;
                isLooping = false;
                document.getElementById('loopBtn').classList.remove('active');
            }
        }

        function loadSettings(customSettings) {
            let settings;
            if (customSettings) {
                settings = customSettings;
            } else {
                try {
                    const savedSettings = localStorage.getItem('synthSettings');
                    settings = savedSettings ? JSON.parse(savedSettings) : DEFAULTS;
                } catch {
                    settings = DEFAULTS;
                }
            }

            document.getElementById('waveType').value = settings.waveType || DEFAULTS.waveType;
            document.getElementById('filterType').value = settings.filterType || DEFAULTS.filterType;
            document.getElementById('startFreq').value = document.getElementById('startFreqInput').value = settings.startFreq || DEFAULTS.startFreq;
            document.getElementById('endFreq').value = document.getElementById('endFreqInput').value = settings.endFreq || DEFAULTS.endFreq;
            document.getElementById('audioDuration').value = document.getElementById('audioDurationInput').value = settings.audioDuration || DEFAULTS.audioDuration;
            document.getElementById('decayTime').value = document.getElementById('decayTimeInput').value = settings.decayTime || DEFAULTS.decayTime;
            document.getElementById('attackTime').value = document.getElementById('attackTimeInput').value = settings.attackTime || DEFAULTS.attackTime;
            document.getElementById('filterFreq').value = document.getElementById('filterFreqInput').value = settings.filterFreq || DEFAULTS.filterFreq;
            document.getElementById('filterQ').value = document.getElementById('filterQInput').value = settings.filterQ || DEFAULTS.filterQ;
        }

        function saveSettings() {
            localStorage.setItem('synthSettings', JSON.stringify(getSettingsFromUI()));
        }
        
    </script>
</body>
</html>
